

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Setting up a Windows Host &mdash; Ansible Documentation</title>
  

  
  
  
  
    <link rel="canonical" href="https://docs.ansible.com/ansible/latest/user_guide/windows_setup.html"/>
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>
  <link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.min.css' rel='stylesheet' type='text/css'>

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/ansible.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/ansible.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Windows Remote Management" href="windows_winrm.html" />
    <link rel="prev" title="Windows Guides" href="windows.html" /> <!---- extra head elements for Ansible beyond RTD Sphinx Theme --->
<script type="text/javascript" src="//www.redhat.com/dtm.js"></script>
<!-- <meta class="swiftype" name="published_at" data-type="date" content="2017-12-13" /> -->
<meta class="swiftype" name="version" data-type="string" content="devel">

<!-- Google Tag Manager Data Layer -->
<script>
 dataLayer = [];
</script>
<!-- End Google Tag Manager Data Layer -->

<script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script> 
</head>

<body class="wy-body-for-nav">
   <!---- extra body elements for Ansible beyond RTD Sphinx Theme --->
<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-PSB293" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer','GTM-PSB293');</script>
<!-- End Google Tag Manager -->

  <div class="DocSite-globalNav ansibleNav">
      <ul>
          <li><a href="https://www.ansible.com/ansiblefest" target="_blank">AnsibleFest</a></li>
          <li><a href="https://www.ansible.com/tower" target="_blank">Products</a></li>
          <li><a href="https://www.ansible.com/community" target="_blank">Community</a></li>
          <li><a href="https://www.ansible.com/webinars-training" target="_blank">Webinars & Training</a></li>
          <li><a href="https://www.ansible.com/blog" target="_blank">Blog</a></li>
      </ul>
  </div>

<a class="DocSite-nav" href="/" style="padding-bottom: 30px;">

  <img class="DocSiteNav-logo"
    src="../_static/images/logo_invert.png"
    alt="Ansible Logo">
  <div class="DocSiteNav-title">
    Documentation
  </div>
</a> 
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Ansible
          

          
          </a>

          
            
            
              <div class="version">
                devel
              </div>
            
          

          <!--- Based on https://github.com/rtfd/sphinx_rtd_theme/pull/438/files -->

<div class="version">
  
    <div class="version-dropdown">
      <select class="version-list" id="version-list" onchange="javascript:location.href = this.value;">
        <script> x = document.getElementById("version-list"); </script>
        
          <script>
            current_url = window.location.href;
            option = document.createElement("option");
            option.text = "latest";
            if ( "latest" == "devel" ) {
              option.selected = true;
            }
            if (current_url.search("devel") > -1) {
              option.value = current_url.replace("devel","latest");
            } else {
              option.value = current_url.replace("latest","latest");
            }
            x.add(option);
          </script>
        
          <script>
            current_url = window.location.href;
            option = document.createElement("option");
            option.text = "2.8";
            if ( "2.8" == "devel" ) {
              option.selected = true;
            }
            if (current_url.search("devel") > -1) {
              option.value = current_url.replace("devel","2.8");
            } else {
              option.value = current_url.replace("latest","2.8");
            }
            x.add(option);
          </script>
        
          <script>
            current_url = window.location.href;
            option = document.createElement("option");
            option.text = "2.7";
            if ( "2.7" == "devel" ) {
              option.selected = true;
            }
            if (current_url.search("devel") > -1) {
              option.value = current_url.replace("devel","2.7");
            } else {
              option.value = current_url.replace("latest","2.7");
            }
            x.add(option);
          </script>
        
          <script>
            current_url = window.location.href;
            option = document.createElement("option");
            option.text = "devel";
            if ( "devel" == "devel" ) {
              option.selected = true;
            }
            if (current_url.search("devel") > -1) {
              option.value = current_url.replace("devel","devel");
            } else {
              option.value = current_url.replace("latest","devel");
            }
            x.add(option);
          </script>
        
      </select>
    </div>
  
</div>
          
<div role="search">
<!--  <form id="rtd-search-form" class="wy-form" action="../search.html" -->
  <form id="rtd-search-form" class="wy-form"  method="get">
    <input type="text" class="st-default-search-input" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Installation, Upgrade &amp; Configuration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation_guide/index.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../porting_guides/porting_guides.html">Ansible Porting Guides</a></li>
</ul>
<p class="caption"><span class="caption-text">Using Ansible</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="quickstart.html">Ansible Quickstart Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="basic_concepts.html">Ansible concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro_getting_started.html">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro_inventory.html">How to build your inventory</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro_dynamic_inventory.html">Working with dynamic inventory</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro_patterns.html">Patterns: targeting hosts and groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro_adhoc.html">Introduction to ad-hoc commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="connection_details.html">Connection methods and details</a></li>
<li class="toctree-l2"><a class="reference internal" href="command_line_tools.html">Working with command line tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="playbooks.html">Working With Playbooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="become.html">Understanding privilege escalation: become</a></li>
<li class="toctree-l2"><a class="reference internal" href="vault.html">Ansible Vault</a></li>
<li class="toctree-l2"><a class="reference internal" href="sample_setup.html">Sample Ansible setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="modules.html">Working With Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../plugins/plugins.html">Working With Plugins</a></li>
<li class="toctree-l2"><a class="reference internal" href="intro_bsd.html">Ansible and BSD</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="windows.html">Windows Guides</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Setting up a Windows Host</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#host-requirements">Host Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#winrm-setup">WinRM Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="#windows-ssh-setup">Windows SSH Setup</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="windows_winrm.html">Windows Remote Management</a></li>
<li class="toctree-l3"><a class="reference internal" href="windows_usage.html">Using Ansible and Windows</a></li>
<li class="toctree-l3"><a class="reference internal" href="windows_dsc.html">Desired State Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="windows_performance.html">Windows performance</a></li>
<li class="toctree-l3"><a class="reference internal" href="windows_faq.html">Windows Frequently Asked Questions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="collections_using.html">Using collections</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Contributing to Ansible</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../community/index.html">Ansible Community Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">Extending Ansible</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/index.html">Developer Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">Common Ansible Scenarios</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scenario_guides/cloud_guides.html">Public Cloud Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scenario_guides/network_guides.html">Network Technology Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scenario_guides/virt_guides.html">Virtualization and Containerization Guides</a></li>
</ul>
<p class="caption"><span class="caption-text">Network Automation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../network/getting_started/index.html">Network Automation Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/user_guide/index.html">Network Automation Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../network/dev_guide/index.html">Network Automation Developer Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">Ansible Galaxy</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../galaxy/user_guide.html">Galaxy User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../galaxy/dev_guide.html">Galaxy Developer Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference &amp; Appendices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules/modules_by_category.html">Module Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/playbooks_keywords.html">Playbook Keywords</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/common_return_values.html">Return Values</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/config.html">Ansible Configuration Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/general_precedence.html">Controlling how Ansible behaves: precedence rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/YAMLSyntax.html">YAML Syntax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/python_3_support.html">Python 3 Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/interpreter_discovery.html">Interpreter Discovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/release_and_maintenance.html">Release and maintenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/test_strategies.html">Testing Strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/testing/sanity/index.html">Sanity Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/module_utils.html">Ansible Reference: Module Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/special_variables.html">Special Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/tower.html">Red Hat Ansible Tower</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/automationhub.html">Ansible Automation Hub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference_appendices/logging.html">Logging Ansible output</a></li>
</ul>
<p class="caption"><span class="caption-text">Roadmaps</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../roadmap/index.html">Ansible Roadmap</a></li>
</ul>

            
          
        </div>
        
         <!-- extra nav elements for Ansible beyond RTD Sphinx Theme --->
<!-- changeable widget links to tower - do not change as image controlled by Ansible-->
<div id="sideBanner">
  <br/>
  <a href="https://www.ansible.com/docs-left?utm_source=docs">
    <img style="border-width:0px;" src="https://cdn2.hubspot.net/hubfs/330046/docs-graphics/ASB-docs-left-rail.png" />
  </a>
  <br/><br/><br/>
</div>
      </div>
    </nav>
  </div>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Ansible</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          
















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">User Guide</a> &raquo;</li>
        
          <li><a href="windows.html">Windows Guides</a> &raquo;</li>
        
      <li>Setting up a Windows Host</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <!-- Ansible-specific additions for modules etc -->
                
                  <a href="https://github.com/ansible/ansible/edit/devel/docs/docsite/rst/user_guide/windows_setup.rst?description=%23%23%23%23%23%20SUMMARY%0A%3C!---%20Your%20description%20here%20--%3E%0A%0A%0A%23%23%23%23%23%20ISSUE%20TYPE%0A-%20Docs%20Pull%20Request%0A%0A%2Blabel:%20docsite_pr" class="fa fa-github"> Edit on GitHub</a>
                
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <!--- Based on sphinx versionwarning extension. Extension currently only works on READTHEDOCS -->
  <script>
    // Create a banner if we're not on the official docs site
    if (location.host == "docs.testing.ansible.com") {
      document.write('<div id="testing_banner_id" class="admonition important">');
      para = document.createElement('p');
      banner_text=document.createTextNode("This is a testing site. For the official docs go to https://docs.ansible.com/");
      para.appendChild(banner_text);
      element = document.getElementById('testing_banner_id');
      element.appendChild(para);
      document.write('</div>');
    }

    // Create a banner if we're not the latest version
    current_url = window.location.href;
    if ((current_url.search("latest") > -1) || (current_url.search("/2.9/") > -1)) {
     // no banner for latest release
    } else if (current_url.search("devel") > -1) {
      document.write('<div id="banner_id" class="admonition caution">');
      para = document.createElement('p');
      banner_text=document.createTextNode("You are reading the *devel* version of the Ansible documentation - this version is not guaranteed stable. Use the version selection to the left if you want the latest stable released version.");
      para.appendChild(banner_text);
      element = document.getElementById('banner_id');
      element.appendChild(para);
      document.write('</div>');
    } else {
      document.write('<div id="banner_id" class="admonition caution">');
      para = document.createElement('p');
      banner_text=document.createTextNode("You are reading an older version of the Ansible documentation. Use the version selection to the left if you want the latest stable released version.");
      para.appendChild(banner_text);
      element = document.getElementById('banner_id');
      element.appendChild(para);
      document.write('</div>');
    }
  </script>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="setting-up-a-windows-host">
<span id="windows-setup"></span><h1>Setting up a Windows Host<a class="headerlink" href="#setting-up-a-windows-host" title="Permalink to this headline">¶</a></h1>
<p>This document discusses the setup that is required before Ansible can communicate with a Microsoft Windows host.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#host-requirements" id="id1">Host Requirements</a><ul>
<li><a class="reference internal" href="#upgrading-powershell-and-net-framework" id="id2">Upgrading PowerShell and .NET Framework</a></li>
<li><a class="reference internal" href="#winrm-memory-hotfix" id="id3">WinRM Memory Hotfix</a></li>
</ul>
</li>
<li><a class="reference internal" href="#winrm-setup" id="id4">WinRM Setup</a><ul>
<li><a class="reference internal" href="#winrm-listener" id="id5">WinRM Listener</a><ul>
<li><a class="reference internal" href="#setup-winrm-listener" id="id6">Setup WinRM Listener</a></li>
<li><a class="reference internal" href="#delete-winrm-listener" id="id7">Delete WinRM Listener</a></li>
</ul>
</li>
<li><a class="reference internal" href="#winrm-service-options" id="id8">WinRM Service Options</a></li>
<li><a class="reference internal" href="#common-winrm-issues" id="id9">Common WinRM Issues</a><ul>
<li><a class="reference internal" href="#http-401-credentials-rejected" id="id10">HTTP 401/Credentials Rejected</a></li>
<li><a class="reference internal" href="#http-500-error" id="id11">HTTP 500 Error</a></li>
<li><a class="reference internal" href="#timeout-errors" id="id12">Timeout Errors</a></li>
<li><a class="reference internal" href="#connection-refused-errors" id="id13">Connection Refused Errors</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#windows-ssh-setup" id="id14">Windows SSH Setup</a><ul>
<li><a class="reference internal" href="#installing-win32-openssh" id="id15">Installing Win32-OpenSSH</a></li>
<li><a class="reference internal" href="#configuring-the-win32-openssh-shell" id="id16">Configuring the Win32-OpenSSH shell</a></li>
<li><a class="reference internal" href="#win32-openssh-authentication" id="id17">Win32-OpenSSH Authentication</a></li>
<li><a class="reference internal" href="#configuring-ansible-for-ssh-on-windows" id="id18">Configuring Ansible for SSH on Windows</a></li>
<li><a class="reference internal" href="#known-issues-with-ssh-on-windows" id="id19">Known issues with SSH on Windows</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="host-requirements">
<h2><a class="toc-backref" href="#id1">Host Requirements</a><a class="headerlink" href="#host-requirements" title="Permalink to this headline">¶</a></h2>
<p>For Ansible to communicate to a Windows host and use Windows modules, the
Windows host must meet these requirements:</p>
<ul class="simple">
<li>Ansible can generally manage Windows versions under current
and extended support from Microsoft. Ansible can manage desktop OSs including
Windows 7, 8.1, and 10, and server OSs including Windows Server 2008,
2008 R2, 2012, 2012 R2, 2016, and 2019.</li>
<li>Ansible requires PowerShell 3.0 or newer and at least .NET 4.0 to be
installed on the Windows host.</li>
<li>A WinRM listener should be created and activated. More details for this can be
found below.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">While these are the base requirements for Ansible connectivity, some Ansible
modules have additional requirements, such as a newer OS or PowerShell
version. Please consult the module’s documentation page
to determine whether a host meets those requirements.</p>
</div>
<div class="section" id="upgrading-powershell-and-net-framework">
<h3><a class="toc-backref" href="#id2">Upgrading PowerShell and .NET Framework</a><a class="headerlink" href="#upgrading-powershell-and-net-framework" title="Permalink to this headline">¶</a></h3>
<p>Ansible requires PowerShell version 3.0 and .NET Framework 4.0 or newer to function on older operating systems like Server 2008 and Windows 7. The base image does not meet this
requirement. You can use the <a class="reference external" href="https://github.com/jborean93/ansible-windows/blob/master/scripts/Upgrade-PowerShell.ps1">Upgrade-PowerShell.ps1</a> script to update these.</p>
<p>This is an example of how to run this script from PowerShell:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="nv">$url</span> <span class="p">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/jborean93/ansible-windows/master/scripts/Upgrade-PowerShell.ps1&quot;</span>
<span class="nv">$file</span> <span class="p">=</span> <span class="s2">&quot;$env:temp\Upgrade-PowerShell.ps1&quot;</span>
<span class="nv">$username</span> <span class="p">=</span> <span class="s2">&quot;Administrator&quot;</span>
<span class="nv">$password</span> <span class="p">=</span> <span class="s2">&quot;Password&quot;</span>

<span class="p">(</span><span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="n">DownloadFile</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$file</span><span class="p">)</span>
<span class="nb">Set-ExecutionPolicy</span> <span class="n">-ExecutionPolicy</span> <span class="n">Unrestricted</span> <span class="n">-Force</span>

<span class="c"># Version can be 3.0, 4.0 or 5.1</span>
<span class="p">&amp;</span><span class="nv">$file</span> <span class="n">-Version</span> <span class="n">5</span><span class="p">.</span><span class="n">1</span> <span class="n">-Username</span> <span class="nv">$username</span> <span class="n">-Password</span> <span class="nv">$password</span> <span class="n">-Verbose</span>
</pre></div>
</div>
<p>Once completed, you will need to remove auto logon
and set the execution policy back to the default of <code class="docutils literal notranslate"><span class="pre">Restricted</span></code>. You can
do this with the following PowerShell commands:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="c"># This isn&#39;t needed but is a good security practice to complete</span>
<span class="nb">Set-ExecutionPolicy</span> <span class="n">-ExecutionPolicy</span> <span class="n">Restricted</span> <span class="n">-Force</span>

<span class="nv">$reg_winlogon_path</span> <span class="p">=</span> <span class="s2">&quot;HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon&quot;</span>
<span class="nb">Set-ItemProperty</span> <span class="n">-Path</span> <span class="nv">$reg_winlogon_path</span> <span class="n">-Name</span> <span class="n">AutoAdminLogon</span> <span class="n">-Value</span> <span class="n">0</span>
<span class="nb">Remove-ItemProperty</span> <span class="n">-Path</span> <span class="nv">$reg_winlogon_path</span> <span class="n">-Name</span> <span class="n">DefaultUserName</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span>
<span class="nb">Remove-ItemProperty</span> <span class="n">-Path</span> <span class="nv">$reg_winlogon_path</span> <span class="n">-Name</span> <span class="n">DefaultPassword</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span>
</pre></div>
</div>
<p>The script works by checking to see what programs need to be installed
(such as .NET Framework 4.5.2) and what PowerShell version is required. If a reboot
is required and the <code class="docutils literal notranslate"><span class="pre">username</span></code> and <code class="docutils literal notranslate"><span class="pre">password</span></code> parameters are set, the
script will automatically reboot and logon when it comes back up from the
reboot. The script will continue until no more actions are required and the
PowerShell version matches the target version. If the <code class="docutils literal notranslate"><span class="pre">username</span></code> and
<code class="docutils literal notranslate"><span class="pre">password</span></code> parameters are not set, the script will prompt the user to
manually reboot and logon when required. When the user is next logged in, the
script will continue where it left off and the process continues until no more
actions are required.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If running on Server 2008, then SP2 must be installed. If running on
Server 2008 R2 or Windows 7, then SP1 must be installed.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Windows Server 2008 can only install PowerShell 3.0; specifying a
newer version will result in the script failing.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">username</span></code> and <code class="docutils literal notranslate"><span class="pre">password</span></code> parameters are stored in plain text
in the registry. Make sure the cleanup commands are run after the script finishes
to ensure no credentials are still stored on the host.</p>
</div>
</div>
<div class="section" id="winrm-memory-hotfix">
<h3><a class="toc-backref" href="#id3">WinRM Memory Hotfix</a><a class="headerlink" href="#winrm-memory-hotfix" title="Permalink to this headline">¶</a></h3>
<p>When running on PowerShell v3.0, there is a bug with the WinRM service that
limits the amount of memory available to WinRM. Without this hotfix installed,
Ansible will fail to execute certain commands on the Windows host. These
hotfixes should installed as part of the system bootstrapping or
imaging process. The script <a class="reference external" href="https://github.com/jborean93/ansible-windows/blob/master/scripts/Install-WMF3Hotfix.ps1">Install-WMF3Hotfix.ps1</a> can be used to install the hotfix on affected hosts.</p>
<p>The following PowerShell command will install the hotfix:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="nv">$url</span> <span class="p">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/jborean93/ansible-windows/master/scripts/Install-WMF3Hotfix.ps1&quot;</span>
<span class="nv">$file</span> <span class="p">=</span> <span class="s2">&quot;$env:temp\Install-WMF3Hotfix.ps1&quot;</span>

<span class="p">(</span><span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="n">DownloadFile</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$file</span><span class="p">)</span>
<span class="n">powershell</span><span class="p">.</span><span class="n">exe</span> <span class="n">-ExecutionPolicy</span> <span class="n">ByPass</span> <span class="o">-File</span> <span class="nv">$file</span> <span class="n">-Verbose</span>
</pre></div>
</div>
<p>For more details, please refer to the <a class="reference external" href="https://support.microsoft.com/en-us/help/2842230/out-of-memory-error-on-a-computer-that-has-a-customized-maxmemorypersh">Hotfix document</a> from Microsoft.</p>
</div>
</div>
<div class="section" id="winrm-setup">
<h2><a class="toc-backref" href="#id4">WinRM Setup</a><a class="headerlink" href="#winrm-setup" title="Permalink to this headline">¶</a></h2>
<p>Once Powershell has been upgraded to at least version 3.0, the final step is for the
WinRM service to be configured so that Ansible can connect to it. There are two
main components of the WinRM service that governs how Ansible can interface with
the Windows host: the <code class="docutils literal notranslate"><span class="pre">listener</span></code> and the <code class="docutils literal notranslate"><span class="pre">service</span></code> configuration settings.</p>
<p>Details about each component can be read below, but the script
<a class="reference external" href="https://github.com/ansible/ansible/blob/devel/examples/scripts/ConfigureRemotingForAnsible.ps1">ConfigureRemotingForAnsible.ps1</a>
can be used to set up the basics. This script sets up both HTTP and HTTPS
listeners with a self-signed certificate and enables the <code class="docutils literal notranslate"><span class="pre">Basic</span></code>
authentication option on the service.</p>
<p>To use this script, run the following in PowerShell:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="nv">$url</span> <span class="p">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/ansible/ansible/devel/examples/scripts/ConfigureRemotingForAnsible.ps1&quot;</span>
<span class="nv">$file</span> <span class="p">=</span> <span class="s2">&quot;$env:temp\ConfigureRemotingForAnsible.ps1&quot;</span>

<span class="p">(</span><span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">WebClient</span><span class="p">).</span><span class="n">DownloadFile</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$file</span><span class="p">)</span>

<span class="n">powershell</span><span class="p">.</span><span class="n">exe</span> <span class="n">-ExecutionPolicy</span> <span class="n">ByPass</span> <span class="o">-File</span> <span class="nv">$file</span>
</pre></div>
</div>
<p>There are different switches and parameters (like <code class="docutils literal notranslate"><span class="pre">-EnableCredSSP</span></code> and
<code class="docutils literal notranslate"><span class="pre">-ForceNewSSLCert</span></code>) that can be set alongside this script. The documentation
for these options are located at the top of the script itself.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The ConfigureRemotingForAnsible.ps1 script is intended for training and
development purposes only and should not be used in a
production environment, since it enables settings (like <code class="docutils literal notranslate"><span class="pre">Basic</span></code> authentication)
that can be inherently insecure.</p>
</div>
<div class="section" id="winrm-listener">
<h3><a class="toc-backref" href="#id5">WinRM Listener</a><a class="headerlink" href="#winrm-listener" title="Permalink to this headline">¶</a></h3>
<p>The WinRM services listens for requests on one or more ports. Each of these ports must have a
listener created and configured.</p>
<p>To view the current listeners that are running on the WinRM service, run the
following command:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="n">winrm</span> <span class="n">enumerate</span> <span class="n">winrm</span><span class="p">/</span><span class="n">config</span><span class="p">/</span><span class="n">Listener</span>
</pre></div>
</div>
<p>This will output something like:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">Listener</span>
    <span class="l l-Scalar l-Scalar-Plain">Address = *</span>
    <span class="l l-Scalar l-Scalar-Plain">Transport = HTTP</span>
    <span class="l l-Scalar l-Scalar-Plain">Port = 5985</span>
    <span class="l l-Scalar l-Scalar-Plain">Hostname</span>
    <span class="l l-Scalar l-Scalar-Plain">Enabled = true</span>
    <span class="l l-Scalar l-Scalar-Plain">URLPrefix = wsman</span>
    <span class="l l-Scalar l-Scalar-Plain">CertificateThumbprint</span>
    <span class="l l-Scalar l-Scalar-Plain">ListeningOn = 10.0.2.15, 127.0.0.1, 192.168.56.155, ::1, fe80::5efe:10.0.2.15%6, fe80::5efe:192.168.56.155%8, fe80:</span><span class="p p-Indicator">:</span>
<span class="l l-Scalar l-Scalar-Plain">ffff:ffff:fffe%2, fe80::203d:7d97:c2ed:ec78%3, fe80::e8ea:d765:2c69:7756%7</span>

<span class="l l-Scalar l-Scalar-Plain">Listener</span>
    <span class="l l-Scalar l-Scalar-Plain">Address = *</span>
    <span class="l l-Scalar l-Scalar-Plain">Transport = HTTPS</span>
    <span class="l l-Scalar l-Scalar-Plain">Port = 5986</span>
    <span class="l l-Scalar l-Scalar-Plain">Hostname = SERVER2016</span>
    <span class="l l-Scalar l-Scalar-Plain">Enabled = true</span>
    <span class="l l-Scalar l-Scalar-Plain">URLPrefix = wsman</span>
    <span class="l l-Scalar l-Scalar-Plain">CertificateThumbprint = E6CDAA82EEAF2ECE8546E05DB7F3E01AA47D76CE</span>
    <span class="l l-Scalar l-Scalar-Plain">ListeningOn = 10.0.2.15, 127.0.0.1, 192.168.56.155, ::1, fe80::5efe:10.0.2.15%6, fe80::5efe:192.168.56.155%8, fe80:</span><span class="p p-Indicator">:</span>
<span class="l l-Scalar l-Scalar-Plain">ffff:ffff:fffe%2, fe80::203d:7d97:c2ed:ec78%3, fe80::e8ea:d765:2c69:7756%7</span>
</pre></div>
</div>
<p>In the example above there are two listeners activated; one is listening on
port 5985 over HTTP and the other is listening on port 5986 over HTTPS. Some of
the key options that are useful to understand are:</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">Transport</span></code>: Whether the listener is run over HTTP or HTTPS, it is
recommended to use a listener over HTTPS as the data is encrypted without
any further changes required.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">Port</span></code>: The port the listener runs on, by default it is <code class="docutils literal notranslate"><span class="pre">5985</span></code> for HTTP
and <code class="docutils literal notranslate"><span class="pre">5986</span></code> for HTTPS. This port can be changed to whatever is required and
corresponds to the host var <code class="docutils literal notranslate"><span class="pre">ansible_port</span></code>.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">URLPrefix</span></code>: The URL prefix to listen on, by default it is <code class="docutils literal notranslate"><span class="pre">wsman</span></code>. If
this is changed, the host var <code class="docutils literal notranslate"><span class="pre">ansible_winrm_path</span></code> must be set to the same
value.</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">CertificateThumbprint</span></code>: If running over an HTTPS listener, this is the
thumbprint of the certificate in the Windows Certificate Store that is used
in the connection. To get the details of the certificate itself, run this
command with the relevant certificate thumbprint in PowerShell:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">$thumbprint = &quot;E6CDAA82EEAF2ECE8546E05DB7F3E01AA47D76CE&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">Get-ChildItem -Path cert:\LocalMachine\My -Recurse | Where-Object { $_.Thumbprint -eq $thumbprint } | Select-Object *</span>
</pre></div>
</div>
</li>
</ul>
<div class="section" id="setup-winrm-listener">
<h4><a class="toc-backref" href="#id6">Setup WinRM Listener</a><a class="headerlink" href="#setup-winrm-listener" title="Permalink to this headline">¶</a></h4>
<p>There are three ways to set up a WinRM listener:</p>
<ul>
<li><p class="first">Using <code class="docutils literal notranslate"><span class="pre">winrm</span> <span class="pre">quickconfig</span></code> for HTTP or
<code class="docutils literal notranslate"><span class="pre">winrm</span> <span class="pre">quickconfig</span> <span class="pre">-transport:https</span></code> for HTTPS. This is the easiest option
to use when running outside of a domain environment and a simple listener is
required. Unlike the other options, this process also has the added benefit of
opening up the Firewall for the ports required and starts the WinRM service.</p>
</li>
<li><p class="first">Using Group Policy Objects. This is the best way to create a listener when the
host is a member of a domain because the configuration is done automatically
without any user input. For more information on group policy objects, see the
<a class="reference external" href="https://msdn.microsoft.com/en-us/library/aa374162(v=vs.85).aspx">Group Policy Objects documentation</a>.</p>
</li>
<li><p class="first">Using PowerShell to create the listener with a specific configuration. This
can be done by running the following PowerShell commands:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="nv">$selector_set</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="n">Address</span> <span class="p">=</span> <span class="s2">&quot;*&quot;</span>
    <span class="n">Transport</span> <span class="p">=</span> <span class="s2">&quot;HTTPS&quot;</span>
<span class="p">}</span>
<span class="nv">$value_set</span> <span class="p">=</span> <span class="p">@{</span>
    <span class="n">CertificateThumbprint</span> <span class="p">=</span> <span class="s2">&quot;E6CDAA82EEAF2ECE8546E05DB7F3E01AA47D76CE&quot;</span>
<span class="p">}</span>

<span class="nb">New-WSManInstance</span> <span class="n">-ResourceURI</span> <span class="s2">&quot;winrm/config/Listener&quot;</span> <span class="n">-SelectorSet</span> <span class="nv">$selector_set</span> <span class="n">-ValueSet</span> <span class="nv">$value_set</span>
</pre></div>
</div>
<p>To see the other options with this PowerShell cmdlet, see
<a class="reference external" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.wsman.management/new-wsmaninstance?view=powershell-5.1">New-WSManInstance</a>.</p>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When creating an HTTPS listener, an existing certificate needs to be
created and stored in the <code class="docutils literal notranslate"><span class="pre">LocalMachine\My</span></code> certificate store. Without a
certificate being present in this store, most commands will fail.</p>
</div>
</div>
<div class="section" id="delete-winrm-listener">
<h4><a class="toc-backref" href="#id7">Delete WinRM Listener</a><a class="headerlink" href="#delete-winrm-listener" title="Permalink to this headline">¶</a></h4>
<p>To remove a WinRM listener:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remove all listeners</span>
<span class="l l-Scalar l-Scalar-Plain">Remove-Item -Path WSMan:\localhost\Listener\* -Recurse -Force</span>

<span class="l l-Scalar l-Scalar-Plain"># Only remove listeners that are run over HTTPS</span>
<span class="l l-Scalar l-Scalar-Plain">Get-ChildItem -Path WSMan:\localhost\Listener | Where-Object { $_.Keys -contains &quot;Transport=HTTPS&quot; } | Remove-Item -Recurse -Force</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">Keys</span></code> object is an array of strings, so it can contain different
values. By default it contains a key for <code class="docutils literal notranslate"><span class="pre">Transport=</span></code> and <code class="docutils literal notranslate"><span class="pre">Address=</span></code>
which correspond to the values from winrm enumerate winrm/config/Listeners.</p>
</div>
</div>
</div>
<div class="section" id="winrm-service-options">
<h3><a class="toc-backref" href="#id8">WinRM Service Options</a><a class="headerlink" href="#winrm-service-options" title="Permalink to this headline">¶</a></h3>
<p>There are a number of options that can be set to control the behavior of the WinRM service component,
including authentication options and memory settings.</p>
<p>To get an output of the current service configuration options, run the
following command:</p>
<div class="highlight-powershell notranslate"><div class="highlight"><pre><span></span><span class="n">winrm</span> <span class="n">get</span> <span class="n">winrm</span><span class="p">/</span><span class="n">config</span><span class="p">/</span><span class="n">Service</span>
<span class="n">winrm</span> <span class="n">get</span> <span class="n">winrm</span><span class="p">/</span><span class="n">config</span><span class="p">/</span><span class="n">Winrs</span>
</pre></div>
</div>
<p>This will output something like:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">Service</span>
    <span class="l l-Scalar l-Scalar-Plain">RootSDDL = O:NSG:BAD:P(A;;GA;;;BA)(A;;GR;;;IU)S:P(AU;FA;GA;;;WD)(AU;SA;GXGW;;;WD)</span>
    <span class="l l-Scalar l-Scalar-Plain">MaxConcurrentOperations = 4294967295</span>
    <span class="l l-Scalar l-Scalar-Plain">MaxConcurrentOperationsPerUser = 1500</span>
    <span class="l l-Scalar l-Scalar-Plain">EnumerationTimeoutms = 240000</span>
    <span class="l l-Scalar l-Scalar-Plain">MaxConnections = 300</span>
    <span class="l l-Scalar l-Scalar-Plain">MaxPacketRetrievalTimeSeconds = 120</span>
    <span class="l l-Scalar l-Scalar-Plain">AllowUnencrypted = false</span>
    <span class="l l-Scalar l-Scalar-Plain">Auth</span>
        <span class="l l-Scalar l-Scalar-Plain">Basic = true</span>
        <span class="l l-Scalar l-Scalar-Plain">Kerberos = true</span>
        <span class="l l-Scalar l-Scalar-Plain">Negotiate = true</span>
        <span class="l l-Scalar l-Scalar-Plain">Certificate = true</span>
        <span class="l l-Scalar l-Scalar-Plain">CredSSP = true</span>
        <span class="l l-Scalar l-Scalar-Plain">CbtHardeningLevel = Relaxed</span>
    <span class="l l-Scalar l-Scalar-Plain">DefaultPorts</span>
        <span class="l l-Scalar l-Scalar-Plain">HTTP = 5985</span>
        <span class="l l-Scalar l-Scalar-Plain">HTTPS = 5986</span>
    <span class="l l-Scalar l-Scalar-Plain">IPv4Filter = *</span>
    <span class="l l-Scalar l-Scalar-Plain">IPv6Filter = *</span>
    <span class="l l-Scalar l-Scalar-Plain">EnableCompatibilityHttpListener = false</span>
    <span class="l l-Scalar l-Scalar-Plain">EnableCompatibilityHttpsListener = false</span>
    <span class="l l-Scalar l-Scalar-Plain">CertificateThumbprint</span>
    <span class="l l-Scalar l-Scalar-Plain">AllowRemoteAccess = true</span>

<span class="l l-Scalar l-Scalar-Plain">Winrs</span>
    <span class="l l-Scalar l-Scalar-Plain">AllowRemoteShellAccess = true</span>
    <span class="l l-Scalar l-Scalar-Plain">IdleTimeout = 7200000</span>
    <span class="l l-Scalar l-Scalar-Plain">MaxConcurrentUsers = 2147483647</span>
    <span class="l l-Scalar l-Scalar-Plain">MaxShellRunTime = 2147483647</span>
    <span class="l l-Scalar l-Scalar-Plain">MaxProcessesPerShell = 2147483647</span>
    <span class="l l-Scalar l-Scalar-Plain">MaxMemoryPerShellMB = 2147483647</span>
    <span class="l l-Scalar l-Scalar-Plain">MaxShellsPerUser = 2147483647</span>
</pre></div>
</div>
<p>While many of these options should rarely be changed, a few can easily impact
the operations over WinRM and are useful to understand. Some of the important
options are:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">Service\AllowUnencrypted</span></code>: This option defines whether WinRM will allow
traffic that is run over HTTP without message encryption. Message level
encryption is only possible when <code class="docutils literal notranslate"><span class="pre">ansible_winrm_transport</span></code> is <code class="docutils literal notranslate"><span class="pre">ntlm</span></code>,
<code class="docutils literal notranslate"><span class="pre">kerberos</span></code> or <code class="docutils literal notranslate"><span class="pre">credssp</span></code>. By default this is <code class="docutils literal notranslate"><span class="pre">false</span></code> and should only be
set to <code class="docutils literal notranslate"><span class="pre">true</span></code> when debugging WinRM messages.</li>
<li><code class="docutils literal notranslate"><span class="pre">Service\Auth\*</span></code>: These flags define what authentication
options are allowed with the WinRM service. By default, <code class="docutils literal notranslate"><span class="pre">Negotiate</span> <span class="pre">(NTLM)</span></code>
and <code class="docutils literal notranslate"><span class="pre">Kerberos</span></code> are enabled.</li>
<li><code class="docutils literal notranslate"><span class="pre">Service\Auth\CbtHardeningLevel</span></code>: Specifies whether channel binding tokens are
not verified (None), verified but not required (Relaxed), or verified and
required (Strict). CBT is only used when connecting with NTLM or Kerberos
over HTTPS.</li>
<li><code class="docutils literal notranslate"><span class="pre">Service\CertificateThumbprint</span></code>: This is the thumbprint of the certificate
used to encrypt the TLS channel used with CredSSP authentication. By default
this is empty; a self-signed certificate is generated when the WinRM service
starts and is used in the TLS process.</li>
<li><code class="docutils literal notranslate"><span class="pre">Winrs\MaxShellRunTime</span></code>: This is the maximum time, in milliseconds, that a
remote command is allowed to execute.</li>
<li><code class="docutils literal notranslate"><span class="pre">Winrs\MaxMemoryPerShellMB</span></code>: This is the maximum amount of memory allocated
per shell, including the shell’s child processes.</li>
</ul>
<p>To modify a setting under the <code class="docutils literal notranslate"><span class="pre">Service</span></code> key in PowerShell:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="c1"># substitute {path} with the path to the option after winrm/config/Service</span>
<span class="l l-Scalar l-Scalar-Plain">Set-Item -Path WSMan:\localhost\Service\{path} -Value &quot;value here&quot;</span>

<span class="l l-Scalar l-Scalar-Plain"># for example, to change Service\Auth\CbtHardeningLevel run</span>
<span class="l l-Scalar l-Scalar-Plain">Set-Item -Path WSMan:\localhost\Service\Auth\CbtHardeningLevel -Value Strict</span>
</pre></div>
</div>
<p>To modify a setting under the <code class="docutils literal notranslate"><span class="pre">Winrs</span></code> key in PowerShell:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="c1"># Substitute {path} with the path to the option after winrm/config/Winrs</span>
<span class="l l-Scalar l-Scalar-Plain">Set-Item -Path WSMan:\localhost\Shell\{path} -Value &quot;value here&quot;</span>

<span class="l l-Scalar l-Scalar-Plain"># For example, to change Winrs\MaxShellRunTime run</span>
<span class="l l-Scalar l-Scalar-Plain">Set-Item -Path WSMan:\localhost\Shell\MaxShellRunTime -Value 2147483647</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If running in a domain environment, some of these options are set by
GPO and cannot be changed on the host itself. When a key has been
configured with GPO, it contains the text <code class="docutils literal notranslate"><span class="pre">[Source=&quot;GPO&quot;]</span></code> next to the value.</p>
</div>
</div>
<div class="section" id="common-winrm-issues">
<h3><a class="toc-backref" href="#id9">Common WinRM Issues</a><a class="headerlink" href="#common-winrm-issues" title="Permalink to this headline">¶</a></h3>
<p>Because WinRM has a wide range of configuration options, it can be difficult
to setup and configure. Because of this complexity, issues that are shown by Ansible
could in fact be issues with the host setup instead.</p>
<p>One easy way to determine whether a problem is a host issue is to
run the following command from another Windows host to connect to the
target Windows host:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="c1"># Test out HTTP</span>
<span class="l l-Scalar l-Scalar-Plain">winrs -r:http://server:5985/wsman -u:Username -p:Password ipconfig</span>

<span class="l l-Scalar l-Scalar-Plain"># Test out HTTPS (will fail if the cert is not verifiable)</span>
<span class="l l-Scalar l-Scalar-Plain">winrs -r:https://server:5986/wsman -u:Username -p:Password -ssl ipconfig</span>

<span class="l l-Scalar l-Scalar-Plain"># Test out HTTPS, ignoring certificate verification</span>
<span class="l l-Scalar l-Scalar-Plain">$username = &quot;Username&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">$password = ConvertTo-SecureString -String &quot;Password&quot; -AsPlainText -Force</span>
<span class="l l-Scalar l-Scalar-Plain">$cred = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $username, $password</span>

<span class="l l-Scalar l-Scalar-Plain">$session_option = New-PSSessionOption -SkipCACheck -SkipCNCheck -SkipRevocationCheck</span>
<span class="l l-Scalar l-Scalar-Plain">Invoke-Command -ComputerName server -UseSSL -ScriptBlock { ipconfig } -Credential $cred -SessionOption $session_option</span>
</pre></div>
</div>
<p>If this fails, the issue is probably related to the WinRM setup. If it works, the issue may not be related to the WinRM setup; please continue reading for more troubleshooting suggestions.</p>
<div class="section" id="http-401-credentials-rejected">
<h4><a class="toc-backref" href="#id10">HTTP 401/Credentials Rejected</a><a class="headerlink" href="#http-401-credentials-rejected" title="Permalink to this headline">¶</a></h4>
<p>A HTTP 401 error indicates the authentication process failed during the initial
connection. Some things to check for this are:</p>
<ul class="simple">
<li>Verify that the credentials are correct and set properly in your inventory with
<code class="docutils literal notranslate"><span class="pre">ansible_user</span></code> and <code class="docutils literal notranslate"><span class="pre">ansible_password</span></code></li>
<li>Ensure that the user is a member of the local Administrators group or has been explicitly
granted access (a connection test with the <code class="docutils literal notranslate"><span class="pre">winrs</span></code> command can be used to
rule this out).</li>
<li>Make sure that the authentication option set by <code class="docutils literal notranslate"><span class="pre">ansible_winrm_transport</span></code> is enabled under
<code class="docutils literal notranslate"><span class="pre">Service\Auth\*</span></code></li>
<li>If running over HTTP and not HTTPS, use <code class="docutils literal notranslate"><span class="pre">ntlm</span></code>, <code class="docutils literal notranslate"><span class="pre">kerberos</span></code> or <code class="docutils literal notranslate"><span class="pre">credssp</span></code>
with <code class="docutils literal notranslate"><span class="pre">ansible_winrm_message_encryption:</span> <span class="pre">auto</span></code> to enable message encryption.
If using another authentication option or if the installed pywinrm version cannot be
upgraded, the <code class="docutils literal notranslate"><span class="pre">Service\AllowUnencrypted</span></code> can be set to <code class="docutils literal notranslate"><span class="pre">true</span></code> but this is
only recommended for troubleshooting</li>
<li>Ensure the downstream packages <code class="docutils literal notranslate"><span class="pre">pywinrm</span></code>, <code class="docutils literal notranslate"><span class="pre">requests-ntlm</span></code>,
<code class="docutils literal notranslate"><span class="pre">requests-kerberos</span></code>, and/or <code class="docutils literal notranslate"><span class="pre">requests-credssp</span></code> are up to date using <code class="docutils literal notranslate"><span class="pre">pip</span></code>.</li>
<li>If using Kerberos authentication, ensure that <code class="docutils literal notranslate"><span class="pre">Service\Auth\CbtHardeningLevel</span></code> is
not set to <code class="docutils literal notranslate"><span class="pre">Strict</span></code>.</li>
<li>When using Basic or Certificate authentication, make sure that the user is a local account and
not a domain account. Domain accounts do not work with Basic and Certificate
authentication.</li>
</ul>
</div>
<div class="section" id="http-500-error">
<h4><a class="toc-backref" href="#id11">HTTP 500 Error</a><a class="headerlink" href="#http-500-error" title="Permalink to this headline">¶</a></h4>
<p>These indicate an error has occurred with the WinRM service. Some things
to check for include:</p>
<ul class="simple">
<li>Verify that the number of current open shells has not exceeded either
<code class="docutils literal notranslate"><span class="pre">WinRsMaxShellsPerUser</span></code> or any of the other Winrs quotas haven’t been
exceeded.</li>
</ul>
</div>
<div class="section" id="timeout-errors">
<h4><a class="toc-backref" href="#id12">Timeout Errors</a><a class="headerlink" href="#timeout-errors" title="Permalink to this headline">¶</a></h4>
<p>These usually indicate an error with the network connection where
Ansible is unable to reach the host. Some things to check for include:</p>
<ul class="simple">
<li>Make sure the firewall is not set to block the configured WinRM listener ports</li>
<li>Ensure that a WinRM listener is enabled on the port and path set by the host vars</li>
<li>Ensure that the <code class="docutils literal notranslate"><span class="pre">winrm</span></code> service is running on the Windows host and configured for
automatic start</li>
</ul>
</div>
<div class="section" id="connection-refused-errors">
<h4><a class="toc-backref" href="#id13">Connection Refused Errors</a><a class="headerlink" href="#connection-refused-errors" title="Permalink to this headline">¶</a></h4>
<p>These usually indicate an error when trying to communicate with the
WinRM service on the host. Some things to check for:</p>
<ul class="simple">
<li>Ensure that the WinRM service is up and running on the host. Use
<code class="docutils literal notranslate"><span class="pre">(Get-Service</span> <span class="pre">-Name</span> <span class="pre">winrm).Status</span></code> to get the status of the service.</li>
<li>Check that the host firewall is allowing traffic over the WinRM port. By default
this is <code class="docutils literal notranslate"><span class="pre">5985</span></code> for HTTP and <code class="docutils literal notranslate"><span class="pre">5986</span></code> for HTTPS.</li>
</ul>
<p>Sometimes an installer may restart the WinRM or HTTP service and cause this error. The
best way to deal with this is to use <code class="docutils literal notranslate"><span class="pre">win_psexec</span></code> from another
Windows host.</p>
</div>
</div>
</div>
<div class="section" id="windows-ssh-setup">
<h2><a class="toc-backref" href="#id14">Windows SSH Setup</a><a class="headerlink" href="#windows-ssh-setup" title="Permalink to this headline">¶</a></h2>
<p>Ansible 2.8 has added an experimental SSH connection for Windows managed nodes.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Use this feature at your own risk!
Using SSH with Windows is experimental, the implementation may make
backwards incompatible changes in feature releases. The server side
components can be unreliable depending on the version that is installed.</p>
</div>
<div class="section" id="installing-win32-openssh">
<h3><a class="toc-backref" href="#id15">Installing Win32-OpenSSH</a><a class="headerlink" href="#installing-win32-openssh" title="Permalink to this headline">¶</a></h3>
<p>The first step to using SSH with Windows is to install the <a class="reference external" href="https://github.com/PowerShell/Win32-OpenSSH">Win32-OpenSSH</a>
service on the Windows host. Microsoft offers a way to install <code class="docutils literal notranslate"><span class="pre">Win32-OpenSSH</span></code> through a Windows
capability but currently the version that is installed through this process is
too old to work with Ansible. To install <code class="docutils literal notranslate"><span class="pre">Win32-OpenSSH</span></code> for use with
Ansible, select one of these three installation options:</p>
<ul>
<li><p class="first">Manually install the service, following the <a class="reference external" href="https://github.com/PowerShell/Win32-OpenSSH/wiki/Install-Win32-OpenSSH">install instructions</a>
from Microsoft.</p>
</li>
<li><p class="first">Use <code class="docutils literal notranslate"><span class="pre">win_chocolatey</span></code> to install the service:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">install the Win32-OpenSSH service</span>
  <span class="l l-Scalar l-Scalar-Plain">win_chocolatey</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">openssh</span>
    <span class="l l-Scalar l-Scalar-Plain">package_params</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/SSHServerFeature</span>
    <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
</pre></div>
</div>
</li>
<li><p class="first">Use an existing Ansible Galaxy role like <a class="reference external" href="https://galaxy.ansible.com/jborean93/win_openssh">jborean93.win_openssh</a>:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make sure the role has been downloaded first</span>
<span class="l l-Scalar l-Scalar-Plain">ansible-galaxy install jborean93.win_openssh</span>

<span class="l l-Scalar l-Scalar-Plain"># main.yml</span>
<span class="l l-Scalar l-Scalar-Plain">- name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">install Win32-OpenSSH service</span>
  <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">windows</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>
  <span class="l l-Scalar l-Scalar-Plain">roles</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">role</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jborean93.win_openssh</span>
    <span class="l l-Scalar l-Scalar-Plain">opt_openssh_setup_service</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
</pre></div>
</div>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">Win32-OpenSSH</span></code> is still a beta product and is constantly
being updated to include new features and bugfixes. If you are using SSH as
a connection option for Windows, it is highly recommend you install the
latest release from one of the 3 methods above.</p>
</div>
</div>
<div class="section" id="configuring-the-win32-openssh-shell">
<h3><a class="toc-backref" href="#id16">Configuring the Win32-OpenSSH shell</a><a class="headerlink" href="#configuring-the-win32-openssh-shell" title="Permalink to this headline">¶</a></h3>
<p>By default <code class="docutils literal notranslate"><span class="pre">Win32-OpenSSH</span></code> will use <code class="docutils literal notranslate"><span class="pre">cmd.exe</span></code> as a shell. To configure a
different shell, use an Ansible task to define the registry setting:</p>
<div class="highlight-YAML+Jinja notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">set the default shell to PowerShell</span>
  <span class="l l-Scalar l-Scalar-Plain">win_regedit</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">HKLM:\SOFTWARE\OpenSSH</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DefaultShell</span>
    <span class="l l-Scalar l-Scalar-Plain">data</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</span>
    <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">string</span>
    <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>

<span class="c1"># Or revert the settings back to the default, cmd</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">set the default shell to cmd</span>
  <span class="l l-Scalar l-Scalar-Plain">win_regedit</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">HKLM:\SOFTWARE\OpenSSH</span>
    <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DefaultShell</span>
    <span class="l l-Scalar l-Scalar-Plain">state</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">absent</span>
</pre></div>
</div>
</div>
<div class="section" id="win32-openssh-authentication">
<h3><a class="toc-backref" href="#id17">Win32-OpenSSH Authentication</a><a class="headerlink" href="#win32-openssh-authentication" title="Permalink to this headline">¶</a></h3>
<p>Win32-OpenSSH authentication with Windows is similar to SSH
authentication on Unix/Linux hosts. You can use a plaintext password or
SSH public key authentication, add public keys to an <code class="docutils literal notranslate"><span class="pre">authorized_key</span></code> file
in the <code class="docutils literal notranslate"><span class="pre">.ssh</span></code> folder of the user’s profile directory, and configure the
service using the <code class="docutils literal notranslate"><span class="pre">sshd_config</span></code> file used by the SSH service as you would on
a Unix/Linux host.</p>
<p>When using SSH key authentication with Ansible, the remote session won’t have access to the
user’s credentials and will fail when attempting to access a network resource.
This is also known as the double-hop or credential delegation issue. There are
two ways to work around this issue:</p>
<ul class="simple">
<li>Use plaintext password auth by setting <code class="docutils literal notranslate"><span class="pre">ansible_password</span></code></li>
<li>Use <code class="docutils literal notranslate"><span class="pre">become</span></code> on the task with the credentials of the user that needs access to the remote resource</li>
</ul>
</div>
<div class="section" id="configuring-ansible-for-ssh-on-windows">
<h3><a class="toc-backref" href="#id18">Configuring Ansible for SSH on Windows</a><a class="headerlink" href="#configuring-ansible-for-ssh-on-windows" title="Permalink to this headline">¶</a></h3>
<p>To configure Ansible to use SSH for Windows hosts, you must set two connection variables:</p>
<ul class="simple">
<li>set <code class="docutils literal notranslate"><span class="pre">ansible_connection</span></code> to <code class="docutils literal notranslate"><span class="pre">ssh</span></code></li>
<li>set <code class="docutils literal notranslate"><span class="pre">ansible_shell_type</span></code> to <code class="docutils literal notranslate"><span class="pre">cmd</span></code> or <code class="docutils literal notranslate"><span class="pre">powershell</span></code></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">ansible_shell_type</span></code> variable should reflect the <code class="docutils literal notranslate"><span class="pre">DefaultShell</span></code>
configured on the Windows host. Set to <code class="docutils literal notranslate"><span class="pre">cmd</span></code> for the default shell or set to
<code class="docutils literal notranslate"><span class="pre">powershell</span></code> if the <code class="docutils literal notranslate"><span class="pre">DefaultShell</span></code> has been changed to PowerShell.</p>
</div>
<div class="section" id="known-issues-with-ssh-on-windows">
<h3><a class="toc-backref" href="#id19">Known issues with SSH on Windows</a><a class="headerlink" href="#known-issues-with-ssh-on-windows" title="Permalink to this headline">¶</a></h3>
<p>Using SSH with Windows is experimental, and we expect to uncover more issues.
Here are the known ones:</p>
<ul class="simple">
<li>Win32-OpenSSH versions older than <code class="docutils literal notranslate"><span class="pre">v7.9.0.0p1-Beta</span></code> do not work when <code class="docutils literal notranslate"><span class="pre">powershell</span></code> is the shell type</li>
<li>While SCP should work, SFTP is the recommended SSH file transfer mechanism to use when copying or fetching a file</li>
</ul>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference internal" href="playbooks_intro.html#about-playbooks"><span class="std std-ref">Intro to Playbooks</span></a></dt>
<dd>An introduction to playbooks</dd>
<dt><a class="reference internal" href="playbooks_best_practices.html#playbooks-best-practices"><span class="std std-ref">Tips and tricks</span></a></dt>
<dd>Best practices advice</dd>
<dt><a class="reference external" href="https://docs.ansible.com/ansible/2.9/modules/list_of_windows_modules.html#windows-modules" title="(in Ansible v2.9)"><span class="xref std std-ref">List of Windows Modules</span></a></dt>
<dd>Windows specific module list, all implemented in PowerShell</dd>
<dt><a class="reference external" href="https://groups.google.com/group/ansible-project">User Mailing List</a></dt>
<dd>Have a question?  Stop by the google group!</dd>
<dt><a class="reference external" href="http://irc.freenode.net">irc.freenode.net</a></dt>
<dd>#ansible IRC chat channel</dd>
</dl>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons">
      
        <a href="windows_winrm.html" class="btn btn-neutral float-right" title="Windows Remote Management"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="windows.html" class="btn btn-neutral" title="Windows Guides"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>


<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','yABGvz2N8PwcwBxyfzUc','2.0.0');
</script>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019 Red Hat, Inc.
      <span class="lastupdated">
        Last updated on Aug 10, 2020.
      </span>

    </p>
  </div> 
</footer>
        </div>
      </div>

    </section>

  </div>

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script>

  
  
    
   <!-- extra footer elements for Ansible beyond RTD Sphinx Theme --->
<!-- begin analytics -->
<script type="text/javascript">
var _hsq = _hsq || [];
_hsq.push(["setContentType", "standard-page"]);
      (function(d,s,i,r) {
      if (d.getElementById(i)){return;}
      var n = d.createElement(s),e = document.getElementsByTagName(s)[0];
      n.id=i;n.src = '//js.hs-analytics.net/analytics/'+(Math.ceil(new Date()/r)*r)+'/330046.js';
      e.parentNode.insertBefore(n, e);
      })(document, "script", "hs-analytics",300000);
</script>
<!-- end analytics -->
<script type="text/javascript">
if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
  _satellite.pageBottom();
}
</script> 

</body>
</html>